{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ action }} Experience - AI Resume Builder{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0"><i class="bi bi-briefcase"></i> {{ action }} Experience</h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Company -->
                        <div class="mb-3">
                            <label for="{{ form.company.id_for_label }}" class="form-label">
                                {{ form.company.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.company }}
                            {% if form.company.errors %}
                                <div class="text-danger small">{{ form.company.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Position -->
                        <div class="mb-3">
                            <label for="{{ form.position.id_for_label }}" class="form-label">
                                {{ form.position.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.position }}
                            {% if form.position.errors %}
                                <div class="text-danger small">{{ form.position.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Employment Type -->
                        <div class="mb-3">
                            <label for="{{ form.employment_type.id_for_label }}" class="form-label">
                                {{ form.employment_type.label }}
                            </label>
                            {{ form.employment_type }}
                            {% if form.employment_type.errors %}
                                <div class="text-danger small">{{ form.employment_type.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- Location Fields -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-geo-alt"></i> Location
                            </label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label for="{{ form.city.id_for_label }}" class="form-label small text-muted">City</label>
                                    {{ form.city }}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.state.id_for_label }}" class="form-label small text-muted">State/Province</label>
                                    {{ form.state }}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.country.id_for_label }}" class="form-label small text-muted">Country</label>
                                    {{ form.country }}
                                </div>
                            </div>
                            {{ form.location }}  {# Hidden field #}
                        </div>
                        
                        <!-- Date Range -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.start_date.id_for_label }}" class="form-label">
                                    {{ form.start_date.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.start_date }}
                                {% if form.start_date.errors %}
                                    <div class="text-danger small">{{ form.start_date.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.end_date.id_for_label }}" class="form-label">
                                    {{ form.end_date.label }}
                                </label>
                                {{ form.end_date }}
                                {% if form.end_date.errors %}
                                    <div class="text-danger small">{{ form.end_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Currently Working -->
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.currently_working }}
                                <label class="form-check-label" for="{{ form.currently_working.id_for_label }}">
                                    {{ form.currently_working.label }}
                                </label>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                {{ form.description.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="text-danger small">{{ form.description.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                Describe your key responsibilities, achievements, and impact in this role.
                            </small>
                        </div>
                        
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Save
                            </button>
                            <a href="{% url 'experience_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Update state dropdown based on selected country
function updateExperienceStates() {
    const countrySelect = document.getElementById('id_experience_country');
    const stateInput = document.getElementById('id_experience_state');
    
    if (!countrySelect || !stateInput) return;
    
    const selectedCountry = countrySelect.value;
    
    // Convert state input to select if states available
    const statesByCountry = {{ states_json|safe }};
    
    if (statesByCountry[selectedCountry] && statesByCountry[selectedCountry].length > 0) {
        // Create select element
        const stateSelect = document.createElement('select');
        stateSelect.id = 'id_experience_state';
        stateSelect.name = 'state';
        stateSelect.className = 'form-select';
        
        // Add empty option
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '--- Select State ---';
        stateSelect.appendChild(emptyOption);
        
        // Add state options
        statesByCountry[selectedCountry].forEach(state => {
            const option = document.createElement('option');
            option.value = state;
            option.textContent = state;
            if (state === stateInput.value) {
                option.selected = true;
            }
            stateSelect.appendChild(option);
        });
        
        // Replace input with select
        stateInput.parentNode.replaceChild(stateSelect, stateInput);
    } else if (stateInput.tagName === 'SELECT') {
        // Convert select back to text input
        const stateTextInput = document.createElement('input');
        stateTextInput.type = 'text';
        stateTextInput.id = 'id_experience_state';
        stateTextInput.name = 'state';
        stateTextInput.className = 'form-control';
        stateTextInput.placeholder = 'State/Province';
        stateTextInput.value = stateInput.value;
        
        stateInput.parentNode.replaceChild(stateTextInput, stateInput);
    }
}

// Combine location fields before form submission
document.querySelector('form').addEventListener('submit', function(e) {
    const city = document.querySelector('[name="city"]').value.trim();
    const state = document.querySelector('[name="state"]').value.trim();
    const country = document.querySelector('[name="country"]').value.trim();
    
    const locationParts = [];
    if (city) locationParts.push(city);
    if (state) locationParts.push(state);
    if (country) locationParts.push(country);
    
    document.querySelector('[name="location"]').value = locationParts.join(', ');
});

// Toggle end date based on currently_working checkbox
document.getElementById('{{ form.currently_working.id_for_label }}').addEventListener('change', function() {
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    if (this.checked) {
        endDateInput.disabled = true;
        endDateInput.value = '';
        endDateInput.parentElement.style.opacity = '0.5';
    } else {
        endDateInput.disabled = false;
        endDateInput.parentElement.style.opacity = '1';
    }
});

// Initialize end date state on page load
if (document.getElementById('{{ form.currently_working.id_for_label }}').checked) {
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    endDateInput.disabled = true;
    endDateInput.parentElement.style.opacity = '0.5';
}

// Initialize states on page load
updateExperienceStates();
</script>
{% endblock %}

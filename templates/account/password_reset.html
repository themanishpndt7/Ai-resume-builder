{% extends 'base.html' %}
{% load static %}

{% block title %}Password Reset - AI Resume Builder{% endblock %}

{% block extra_css %}
  <style>
    /* Reuse login page visual language */
    #particles-canvas-login, #particles-canvas-reset { position: fixed; inset: 0; z-index: -1; }
    .futuristic-reset-container, .futuristic-login-container { min-height: calc(100vh - 120px); display:flex; align-items:center; }
    .glass-card-reset, .glass-card-login { max-width:620px; width:100%; border-radius:14px; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); background: rgba(255,255,255,0.04); }
    .animate-fade-slide { animation: fadeInUp 420ms ease both; }
    @keyframes fadeInUp { from { opacity:0; transform: translateY(10px);} to {opacity:1; transform:none;} }
    .close-x { position:absolute; right:1rem; top:1rem; z-index:5; }
    .password-strength-list .bi { margin-right:8px; }
  </style>
{% endblock %}

{% block content %}
  <!-- Reuse the animated login background and floating elements from the login page for consistent look -->
  <canvas id="particles-canvas-login"></canvas>
  <div id="floating-elements" aria-hidden="true">
    <div class="float-elem e1"></div>
    <div class="float-elem e2"></div>
    <div class="float-elem e3"></div>
    <div class="float-elem e4"></div>
  </div>

  <div class="futuristic-login-container">
    <div class="container">
      <div class="row align-items-center justify-content-center py-5">
        <div class="col-lg-8">
          <div class="glass-card-login p-4 p-md-5 shadow animate-fade-slide position-relative" role="region" aria-labelledby="reset-title">
            <button class="btn btn-link close-x" aria-label="Close" onclick="location.href='{% url 'account_login' %}'"><i class="bi bi-x-lg fs-4"></i></button>

            <div class="text-center mb-3">
              <h3 id="reset-title" class="mb-1"><i class="bi bi-key-fill me-2"></i>Reset Your Password</h3>
              <p class="text-muted small mb-0">Enter your email to receive a one-time code and reset your password.</p>
            </div>

            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                  {% if message.tags == 'success' %}<i class="bi bi-check-circle-fill me-1"></i>
                  {% elif message.tags == 'error' or message.tags == 'danger' %}<i class="bi bi-exclamation-triangle-fill me-1"></i>
                  {% else %}<i class="bi bi-info-circle-fill me-1"></i>{% endif %}
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            {% endif %}

            <div id="step-email" {% if show_new_password or form.is_bound and form.data.otp %}style="display:none;"{% endif %}>
              <form method="post" action="{% url 'password_reset_request' %}" id="emailForm" novalidate>
                {% csrf_token %}
                <div class="mb-3">
                  <label for="id_email" class="form-label">Email address</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-envelope-fill"></i></span>
                    <input type="email" name="email" id="id_email" class="form-control" placeholder="you@example.com" value="{{ request.session.password_reset_email|default:'' }}" required aria-required="true">
                  </div>
                </div>

                <div class="d-flex align-items-center">
                  <button type="submit" name="send_otp" class="btn btn-primary me-2" id="sendOtpBtn">Send OTP</button>
                  <div id="emailSpinner" class="spinner-border spinner-border-sm text-primary ms-2" role="status" style="display:none;" aria-hidden="true"></div>
                  <small class="text-muted ms-auto">We will never share your email.</small>
                </div>
              </form>
            </div>

            <div id="step-otp" {% if not request.session.password_reset_just_sent and not form.is_bound and not show_new_password %}style="display:none;"{% endif %} class="mt-3">
              <form method="post" action="{% url 'password_reset_request' %}" id="otpForm" novalidate>
                {% csrf_token %}
                <input type="hidden" name="email" value="{{ request.session.password_reset_email|default:'' }}">
                <div class="mb-3">
                  <label for="id_otp" class="form-label">Enter 6-digit code</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-shield-lock-fill"></i></span>
                    <input type="text" name="otp" id="id_otp" maxlength="6" class="form-control" placeholder="123456" inputmode="numeric" required aria-required="true">
                  </div>
                  <div class="form-text">Check your inbox â€” code expires in 10 minutes.</div>
                </div>
                <div class="d-flex align-items-center">
                  <button type="submit" name="verify_otp" class="btn btn-primary me-2" id="verifyOtpBtn">Verify OTP</button>
                  <button type="button" class="btn btn-link ms-2" id="resendOtpBtn">Resend</button>
                  <div id="otpSpinner" class="spinner-border spinner-border-sm text-primary ms-2" role="status" style="display:none;" aria-hidden="true"></div>
                </div>
              </form>
            </div>

            <div id="step-new-password" {% if not show_new_password %}style="display:none;"{% endif %} class="mt-3">
              <form method="post" action="{% url 'password_reset_confirm_simple' %}" id="newPasswordForm" novalidate>
                {% csrf_token %}
                {% if new_password_form %}
                  <input type="hidden" name="email" value="{{ new_password_form.email.value }}">
                  <input type="hidden" name="otp" value="{{ new_password_form.otp.value }}">
                {% else %}
                  <input type="hidden" name="email" value="{{ request.session.reset_email|default:'' }}">
                  <input type="hidden" name="otp" value="{{ request.session.reset_otp|default:'' }}">
                {% endif %}

                <div class="mb-3 position-relative">
                  <label for="id_password1" class="form-label">New password</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                    <input type="password" name="password1" id="id_password1" class="form-control" placeholder="Create a strong password" aria-describedby="password-strength-region" required>
                    <button type="button" class="password-toggle-btn position-absolute" style="right:0.5rem; top:0.65rem;" aria-pressed="false" aria-label="Show password"><i class="bi bi-eye"></i></button>
                  </div>
                </div>

                <div class="mb-3 position-relative">
                  <label for="id_password2" class="form-label">Confirm password</label>
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-lock-fill"></i></span>
                    <input type="password" name="password2" id="id_password2" class="form-control" placeholder="Confirm new password" required>
                    <button type="button" class="password-toggle-btn position-absolute" style="right:0.5rem; top:0.65rem;" aria-pressed="false" aria-label="Show password"><i class="bi bi-eye"></i></button>
                  </div>
                </div>

                <div id="password-strength-region" class="password-strength mt-2 mb-3" aria-live="polite">
                  <ul class="list-unstyled mb-2 password-strength-list">
                    <li class="text-danger" id="pw_len"><i class="bi bi-x-circle-fill"></i> At least 8 characters</li>
                    <li class="text-danger" id="pw_upper"><i class="bi bi-x-circle-fill"></i> Uppercase letter</li>
                    <li class="text-danger" id="pw_lower"><i class="bi bi-x-circle-fill"></i> Lowercase letter</li>
                    <li class="text-danger" id="pw_num"><i class="bi bi-x-circle-fill"></i> Number</li>
                  </ul>
                  <div class="strength-text text-muted">Strength: <span id="strengthText">Weak</span></div>
                </div>

                <div class="d-flex align-items-center">
                  <button type="submit" name="set_new_password" class="btn btn-primary me-2" id="setPasswordBtn" disabled>Set new password</button>
                  <div id="setSpinner" class="spinner-border spinner-border-sm text-primary ms-2" role="status" style="display:none;" aria-hidden="true"></div>
                </div>
                <div class="mt-2 text-danger" id="pwMismatch" style="display:none;">Passwords do not match</div>
              </form>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    // Ensure the canvas id matches the login page so the same background scripts apply
    try{
      const canvas = document.getElementById('particles-canvas-login');
      if(canvas){ canvas.style.position='fixed'; canvas.style.inset=0; canvas.style.zIndex='-1'; }
    }catch(e){}

    // Password toggle and strength logic (reuse from signup/login)
    document.addEventListener('click', function(e){
      if(e.target.closest('.password-toggle-btn')){
        const btn = e.target.closest('.password-toggle-btn');
        const input = btn.parentElement.querySelector('input[type="password"]');
        if(!input) return;
        if(input.type === 'password'){ input.type = 'text'; btn.querySelector('i').className='bi bi-eye-slash'; btn.setAttribute('aria-pressed','true'); }
        else { input.type = 'password'; btn.querySelector('i').className='bi bi-eye'; btn.setAttribute('aria-pressed','false'); }
      }
    });

    const pw1 = document.getElementById('id_password1');
    const pw2 = document.getElementById('id_password2');
    const btnSet = document.getElementById('setPasswordBtn');
    const mismatchEl = document.getElementById('pwMismatch');
    const checks = {
      len: document.getElementById('pw_len'),
      upper: document.getElementById('pw_upper'),
      lower: document.getElementById('pw_lower'),
      num: document.getElementById('pw_num')
    };
    const strengthText = document.getElementById('strengthText');

    function updateStrength(){
      const val = pw1 ? pw1.value : '';
      let score=0;
      if(!pw1) return;
      if(val.length >= 8){ checks.len.classList.remove('text-danger'); checks.len.classList.add('text-success'); checks.len.querySelector('i').className='bi bi-check-circle-fill'; score++; } else { checks.len.classList.add('text-danger'); checks.len.classList.remove('text-success'); checks.len.querySelector('i').className='bi bi-x-circle-fill'; }
      if(/[A-Z]/.test(val)){ checks.upper.classList.remove('text-danger'); checks.upper.classList.add('text-success'); checks.upper.querySelector('i').className='bi bi-check-circle-fill'; score++; } else { checks.upper.classList.add('text-danger'); checks.upper.classList.remove('text-success'); checks.upper.querySelector('i').className='bi bi-x-circle-fill'; }
      if(/[a-z]/.test(val)){ checks.lower.classList.remove('text-danger'); checks.lower.classList.add('text-success'); checks.lower.querySelector('i').className='bi bi-check-circle-fill'; score++; } else { checks.lower.classList.add('text-danger'); checks.lower.classList.remove('text-success'); checks.lower.querySelector('i').className='bi bi-x-circle-fill'; }
      if(/[0-9]/.test(val)){ checks.num.classList.remove('text-danger'); checks.num.classList.add('text-success'); checks.num.querySelector('i').className='bi bi-check-circle-fill'; score++; } else { checks.num.classList.add('text-danger'); checks.num.classList.remove('text-success'); checks.num.querySelector('i').className='bi bi-x-circle-fill'; }

      if(score <=1) strengthText.textContent='Weak';
      else if(score==2) strengthText.textContent='Medium';
      else if(score==3) strengthText.textContent='Good';
      else strengthText.textContent='Strong';

      const allPass = score === 4 && pw1.value.length>0 && pw1.value === (pw2 ? pw2.value : '');
      if(allPass){ btnSet.disabled=false; mismatchEl.style.display='none'; } else { btnSet.disabled=true; if(pw2 && pw2.value && pw1.value!==pw2.value) { mismatchEl.style.display='block'; } else { mismatchEl.style.display='none'; } }
    }

    if(pw1){ pw1.addEventListener('input', updateStrength); }
    if(pw2){ pw2.addEventListener('input', updateStrength); }

    document.querySelectorAll('form').forEach(f => {
      f.addEventListener('submit', function(e){
        const spinner = f.querySelector('.spinner-border');
        if(spinner) spinner.style.display='inline-block';
      });
    });

    document.getElementById('resendOtpBtn')?.addEventListener('click', function(){
      const email = document.querySelector('#id_email') ? document.querySelector('#id_email').value : (document.querySelector('input[name="email"]') ? document.querySelector('input[name="email"]').value : '');
      if(!email) { alert('Please enter your email first'); return; }
      const form = document.createElement('form'); form.method='post'; form.style.display='none'; form.action='{% url "password_reset_request" %}';
      const csrf = document.createElement('input'); csrf.type='hidden'; csrf.name='csrfmiddlewaretoken'; csrf.value='{{ csrf_token }}'; form.appendChild(csrf);
      const inEmail = document.createElement('input'); inEmail.type='hidden'; inEmail.name='email'; inEmail.value=email; form.appendChild(inEmail);
      const send = document.createElement('input'); send.type='hidden'; send.name='send_otp'; send.value='1'; form.appendChild(send);
      document.body.appendChild(form); form.submit();
    });
  </script>
{% endblock %}

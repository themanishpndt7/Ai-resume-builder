{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{# Canonical template for the combined password reset + OTP verify flow.
   This file mirrors the consolidated UI for requesting OTPs, verifying them,
   and setting a new password inline. Keeping it as a separate file ensures
   backward compatibility with views that reference
   `account/password_reset_verify_otp.html`. #}

{% block title %}{% trans "Password Reset" %} - AI Resume Builder{% endblock %}

{% block content %}
<!-- Animated Particle Background -->
<canvas id="particles-canvas-login"></canvas>
<div id="three-container"></div>
<div id="floating-elements" aria-hidden="true">
  <div class="float-elem e1"></div>
  <div class="float-elem e2"></div>
  <div class="float-elem e3"></div>
  <div class="float-elem e4"></div>
</div>

<div class="futuristic-otp-container">
  <div class="container my-5">
    <div class="row align-items-center">
      <!-- Left Side - Info -->
      <div class="col-lg-6 mb-4 mb-lg-0">
        <div class="otp-info-section">
          <h1 class="display-5 fw-bold mb-3">
            <i class="bi bi-shield-check text-success"></i> {% trans "Verify Your Identity" %}
          </h1>
          <p class="h5 fw-semibold text-white mb-2">{% trans "Secure Password Reset" %}</p>
          <p class="small text-muted mb-3">{% trans "Reset your password securely with our OTP verification system" %}</p>
          <p class="lead text-muted mb-4">{% trans "We've sent a secure code to your email. Enter it below to reset your password." %}</p>

          <div class="feature-list">
            <div class="feature-item d-flex align-items-start mb-3">
              <div class="feature-icon me-3">
                <i class="bi bi-envelope-check-fill text-primary fs-4"></i>
              </div>
              <div>
                <h5 class="mb-1">{% trans "Email Sent" %}</h5>
                <p class="text-muted mb-0">{% trans "Check your inbox for the OTP code" %}</p>
              </div>
            </div>

            <div class="feature-item d-flex align-items-start mb-3">
              <div class="feature-icon me-3"><i class="bi bi-key-fill text-info fs-4"></i></div>
              <div>
                <h5 class="mb-1">{% trans "6-Digit Code" %}</h5>
                <p class="text-muted mb-0">{% trans "Enter the code we sent to you" %}</p>
              </div>
            </div>

            <div class="feature-item d-flex align-items-start mb-3">
              <div class="feature-icon me-3"><i class="bi bi-clock-fill text-warning fs-4"></i></div>
              <div>
                <h5 class="mb-1">{% trans "Valid for 10 Minutes" %}</h5>
                <p class="text-muted mb-0">{% trans "Use the code quickly before it expires" %}</p>
              </div>
            </div>

            <div class="mt-4 p-3 rounded howitworks">
              <h6 class="mb-3 text-white"><i class="bi bi-list-check me-2"></i> {% trans "How it works" %}</h6>
              <ol class="how-steps list-unstyled small mb-3">
                <li class="d-flex align-items-start mb-2">
                  <span class="step-badge bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3">1</span>
                  <div>
                    <div class="fw-semibold text-white">{% trans "Enter your account email address below" %}</div>
                    <div class="text-muted small">{% trans "We need your account email to locate your user and send a verification code." %}</div>
                  </div>
                </li>
                <li class="d-flex align-items-start mb-2">
                  <span class="step-badge bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3">2</span>
                  <div>
                    <div class="fw-semibold text-white">{% trans "We'll send you a 6-digit OTP code to your email" %}</div>
                    <div class="text-muted small">{% trans "The code is valid for a short time for your protection." %}</div>
                  </div>
                </li>
                <li class="d-flex align-items-start mb-2">
                  <span class="step-badge bg-warning text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3">3</span>
                  <div>
                    <div class="fw-semibold text-white">{% trans "Enter the OTP to verify your identity" %}</div>
                    <div class="text-muted small">{% trans "Type the 6-digit code you received in the form on the right." %}</div>
                  </div>
                </li>
                <li class="d-flex align-items-start mb-0">
                  <span class="step-badge bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3">4</span>
                  <div>
                    <div class="fw-semibold text-white">{% trans "Set your new password" %}</div>
                    <div class="text-muted small">{% trans "After verification you will be asked to choose a strong new password." %}</div>
                  </div>
                </li>
              </ol>
              <h6 class="mb-1 text-white"><i class="bi bi-shield-lock me-2"></i> {% trans "Security tip" %}</h6>
              <p class="small text-muted mb-0">{% trans "Never share this code. Choose a long, unique password when resetting." %}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Side - OTP Form -->
      <div class="col-lg-6">
        <div class="glass-card-otp shadow-lg border-0">
          <div class="card-header-otp text-center text-white py-4">
            <h3 class="mb-0"><i class="bi bi-key-fill"></i> {% trans "Verify OTP" %}</h3>
            <p class="mb-0 mt-2 small">{% trans "Enter the code from your email" %}</p>
          </div>
          <div class="card-body-otp p-4">
            <div id="messages" aria-live="polite" aria-atomic="true">
              {% if messages %}
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %}-fill" aria-hidden="true"></i>
                    <span class="visually-hidden">{{ message.tags }}:</span>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            {% if request.session.password_reset_email %}
              <div class="otp-sent-banner d-flex align-items-center justify-content-between p-3 rounded mb-3 {% if not request.session.password_reset_just_sent %}hidden-until-focus{% endif %}"
                   role="status" aria-live="polite"
                   data-just-sent="{% if request.session.password_reset_just_sent %}true{% else %}false{% endif %}"
                   data-email="{{ request.session.password_reset_email|default:'' }}">
                <div class="d-flex align-items-center">
                  <div class="banner-icon otp-banner-logo me-3" aria-hidden="true">
                    <svg class="otp-logo" viewBox="0 0 64 64" width="56" height="56" aria-hidden="true" focusable="false">
                      <defs>
                        <linearGradient id="otpGrad" x1="0" x2="1">
                          <stop offset="0%" stop-color="#06b6d4" />
                          <stop offset="100%" stop-color="#7c3aed" />
                        </linearGradient>
                      </defs>
                      <circle cx="32" cy="32" r="28" fill="url(#otpGrad)" />
                      <path d="M20 33 L28 41 L44 25" stroke="#ffffff" stroke-width="3.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  <div>
                    <div class="fw-bold">{% trans "OTP sent" %}</div>
                    <div class="small text-muted">{% trans "OTP has been sent to" %} <strong class="sent-email">{{ request.session.password_reset_email }}</strong>. {% trans "Please check your inbox and spam folder." %}</div>
                  </div>
                </div>
                <div class="text-end d-flex align-items-center">
                  <!-- Open-mail button removed per request -->
                  <button class="btn-close btn-close-white" id="otpBannerClose" aria-label="Close notification"></button>
                </div>
              </div>
            {% endif %}

            {% if debug and request.session.password_reset_debug_otp %}
              <div class="alert alert-warning mt-3">
                <strong>Dev OTP:</strong>
                <code id="devOtp">{{ request.session.password_reset_debug_otp }}</code>
                <button class="btn btn-sm btn-outline-secondary ms-3" id="copyOtpBtn">Copy OTP</button>
                <small class="d-block mt-1 text-muted">This is shown only in development (DEBUG=True).</small>
              </div>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const btn = document.getElementById('copyOtpBtn');
                  if (btn) btn.addEventListener('click', function(e) {
                    const otp = document.getElementById('devOtp').textContent.trim();
                    navigator.clipboard?.writeText(otp).then(function(){
                      btn.textContent = 'Copied';
                      setTimeout(()=> btn.textContent = 'Copy OTP', 1500);
                    }, function(){
                      alert('Copied OTP: ' + otp);
                    });
                  });
                });
              </script>
            {% endif %}

            <div class="d-flex align-items-start bg-info bg-opacity-10 border border-info rounded p-3 mb-3 otp-info-box">
              <i class="bi bi-info-circle-fill fs-4 text-info me-3"></i>
              <div>
                <div class="fw-semibold">{% trans "Didn't receive the code?" %}</div>
                <div class="small text-muted">{% trans "Check your spam folder or request a new code. The OTP code will expire in 10 minutes for your security." %}</div>
              </div>
            </div>

            {% if not request.session.password_reset_email %}
              <form method="post" action="{% url 'password_reset_request' %}" id="passwordResetForm" class="mb-3" role="form" aria-labelledby="sendOtpHeading" novalidate>
                {% csrf_token %}
                <div class="mb-3">
                  <div class="input-group input-group-lg email-input-enhanced">
                    <span class="input-group-text bg-transparent border-end-0 email-icon"><i class="bi bi-envelope-fill" aria-hidden="true"></i></span>
                    <input type="email" name="email" id="id_request_email" class="form-control form-control-lg" placeholder="you@example.com" value="{{ request.session.password_reset_email|default:'' }}" aria-describedby="emailHelp emailValid" required autocomplete="email" inputmode="email">
                    <button type="button" class="btn btn-outline-secondary btn-clear-email d-none" id="clearEmailBtn" aria-label="Clear email"><i class="bi bi-x-lg" aria-hidden="true"></i></button>
                    <span class="input-group-text bg-transparent border-start-0 email-valid-icon d-none" id="emailValid" aria-hidden="true"><i class="bi bi-check-circle-fill text-success"></i></span>
                  </div>
                  <div id="emailHelp" class="form-text small text-muted mt-1" aria-live="polite">Enter the email we should send the OTP to.</div>
                  <div id="emailValidation" class="small mt-2" aria-live="polite" style="display:none;">
                    <span id="emailValidText" class="text-success d-none"><i class="bi bi-check-circle-fill"></i> Email looks good.</span>
                    <span id="emailInvalidText" class="text-danger d-none"><i class="bi bi-exclamation-circle-fill"></i> Please enter a valid email address.</span>
                  </div>
                </div>

                <div class="d-grid mb-2">
                  <div class="d-flex justify-content-center align-items-center">
                    <button type="submit" name="send_otp" id="sendOtpBtn" class="btn btn-lg btn-primary btn-send-otp d-flex justify-content-center align-items-center" aria-label="Send verification code" data-resend-remaining="{{ resend_cooldown_remaining|default:0 }}">
                      <span class="spinner-border spinner-border-sm me-2 d-none" id="sendSpinner" role="status" aria-hidden="true"></span>
                      <i class="bi bi-envelope-paper-fill me-2" aria-hidden="true"></i>
                      <strong>{% trans "Send verification code" %}</strong>
                    </button>
                  </div>
                </div>

                <div id="resendInfo" class="text-center small text-muted mb-3" aria-live="polite" style="display:none;"></div>

                <div class="text-center small text-muted mb-3">{% trans "Or paste a previously received code in the box below." %}</div>
              </form>
            {% else %}
              <div class="mb-3">
                <div class="input-group input-group-lg email-input-enhanced sent-state fade-in">
                  <span class="input-group-text bg-transparent border-end-0 email-icon"><i class="bi bi-envelope-fill" aria-hidden="true"></i></span>
                  <input type="text" readonly class="form-control form-control-lg bg-transparent text-white" value="{{ request.session.password_reset_email }}">
                  <span class="badge bg-success ms-2 align-self-center">Sent</span>
                </div>
                <div class="form-text small text-white mt-1">{% trans "An OTP has been sent to this email. Enter the code below to verify." %}</div>
              </div>
            {% endif %}

            <form method="post" action="{% url 'password_reset_request' %}" id="otpVerifyForm" class="otp-form" role="form" aria-labelledby="verifyOtpHeading" novalidate>
              {% csrf_token %}

              {% if form.non_field_errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert" aria-live="assertive">
                  <i class="bi bi-exclamation-triangle-fill" aria-hidden="true"></i>
                  <strong id="verifyOtpHeading">{% trans "Verification problem" %}</strong>
                  <ul class="mb-0 mt-2">
                    {% for error in form.non_field_errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endif %}

              <input type="hidden" id="id_email" name="email" value="{{ request.session.password_reset_email|default:'' }}">

              <div class="mb-3">
                <label for="id_otp" class="form-label fw-bold small text-white d-block mb-2">
                  <i class="bi bi-key me-1" aria-hidden="true"></i> {% trans "OTP Code" %}
                </label>
                <div class="input-group justify-content-center align-items-center otp-input-group">
                  <input type="text" inputmode="numeric" autocomplete="one-time-code" aria-label="6-digit verification code" class="form-control form-control-otp text-center {% if form.otp.errors %}is-invalid{% endif %}" id="id_otp" name="otp" value="{{ form.otp.value|default:'' }}" placeholder="000000" maxlength="6" pattern="[0-9]{6}" required autofocus>
                </div>
                {% if form.otp.errors %}
                  <div class="invalid-feedback d-block">{{ form.otp.errors }}</div>
                {% endif %}
                <div class="form-text mt-2 small text-muted">{% trans "Enter the 6-digit code from your email" %}</div>
              </div>

              <div class="d-grid gap-2 mb-3">
                <button type="submit" name="verify_otp" class="btn btn-verify btn-lg text-white"><i class="bi bi-check-circle me-2"></i> {% trans "Verify OTP" %}</button>
              </div>
            </form>

            {% if show_new_password %}
              <div class="mt-3 mb-3 new-password-card fade-in">
                <form method="post" action="{% url 'password_reset_request' %}" id="newPasswordForm" novalidate>
                  {% csrf_token %}
                  {# Keep email/otp values from server-side form when available for safety #}
                  <input type="hidden" name="email" value="{% if new_password_form and new_password_form.initial.email %}{{ new_password_form.initial.email }}{% else %}{{ request.session.reset_email|default:request.session.password_reset_email|default:'' }}{% endif %}">
                  <input type="hidden" name="otp" value="{% if new_password_form and new_password_form.initial.otp %}{{ new_password_form.initial.otp }}{% else %}{{ request.session.reset_otp|default:'' }}{% endif %}">

                  {% comment %} Server-side validation errors (non-field) {% endcomment %}
                  {% if new_password_form and new_password_form.non_field_errors %}
                    <div class="alert alert-error alert-dismissible fade show" role="alert" aria-live="assertive">
                      <i class="bi bi-exclamation-circle-fill" aria-hidden="true"></i>
                      <strong class="ms-1">{% trans "Error" %}:</strong>
                      <div class="mt-1">
                        {% for err in new_password_form.non_field_errors %}
                          <div>{{ err }}</div>
                        {% endfor %}
                      </div>
                      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                  {% endif %}

                  <div class="mb-3 password-wrapper">
                    <label for="id_new_password1" class="form-label fw-semibold small mb-2">{% trans "New password" %}</label>
                    <div class="input-group align-items-center">
                      <input type="password"
                             name="password1"
                             id="id_new_password1"
                             class="form-control password-input"
                             placeholder="New password"
                             required
                             aria-describedby="passwordStrength passwordRules"
                             autocomplete="new-password"
                             value="{% if new_password_form %}{{ new_password_form.data.password1|default:'' }}{% endif %}">
                      <button type="button" class="btn password-toggle-btn" data-target="#id_new_password1" aria-pressed="false" aria-label="Show password" tabindex="0" data-show-text="{% trans "Show password" %}" data-hide-text="{% trans "Hide password" %}">
                        <i class="bi bi-eye" aria-hidden="true"></i>
                      </button>
                    </div>

                    <div id="password-strength-region" class="password-strength mt-2" style="display: none;" aria-live="polite">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">{% trans "Password Strength:" %}</small>
                        <small id="passwordStrengthLabel" class="strength-text fw-bold" aria-live="polite" aria-atomic="true"></small>
                      </div>
                      <div class="progress" style="height: 5px;">
                        <div id="passwordStrengthBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                      </div>
                      <ul class="password-requirements mt-2 small text-muted mb-0" id="passwordRequirements">
                        <li id="req-length"><i class="bi bi-x-circle text-danger"></i> {% trans "At least 8 characters" %}</li>
                        <li id="req-uppercase"><i class="bi bi-x-circle text-danger"></i> {% trans "One uppercase letter" %}</li>
                        <li id="req-lowercase"><i class="bi bi-x-circle text-danger"></i> {% trans "One lowercase letter" %}</li>
                        <li id="req-number"><i class="bi bi-x-circle text-danger"></i> {% trans "One number" %}</li>
                      </ul>
                    </div>

                    {% if new_password_form and new_password_form.errors.password1 %}
                      <div class="invalid-feedback d-block mt-2">{{ new_password_form.errors.password1|join:", " }}</div>
                    {% endif %}
                  </div>

                  <div class="mb-3 password-wrapper">
                    <label for="id_new_password2" class="form-label fw-semibold small mb-2">{% trans "Confirm password" %}</label>
                    <div class="input-group align-items-center">
                      <input type="password"
                             name="password2"
                             id="id_new_password2"
                             class="form-control password-input"
                             placeholder="Confirm password"
                             required
                             autocomplete="new-password"
                             aria-describedby="passwordMatch"
                             value="{% if new_password_form %}{{ new_password_form.data.password2|default:'' }}{% endif %}">
                      <button type="button" class="btn password-toggle-btn" data-target="#id_new_password2" aria-pressed="false" aria-label="Show password" tabindex="0" data-show-text="{% trans "Show password" %}" data-hide-text="{% trans "Hide password" %}">
                        <i class="bi bi-eye" aria-hidden="true"></i>
                      </button>
                    </div>

                    <div id="passwordMatch" class="invalid-feedback mt-2" role="status" aria-live="polite" style="display:none;">
                      {% trans "Passwords do not match. Please re-enter your new password." %}
                    </div>

                    {% if new_password_form and new_password_form.errors.password2 %}
                      <div class="invalid-feedback d-block mt-2">{{ new_password_form.errors.password2|join:", " }}</div>
                    {% endif %}
                  </div>

                  <div class="d-grid gap-2 mb-3">
                    <button type="submit" name="set_new_password" class="btn btn-success btn-lg btn-set-password" disabled aria-disabled="true"><i class="bi bi-check-circle me-2"></i> {% trans "Reset Password" %}</button>
                  </div>
                </form>
              </div>
            {% endif %}
            <script>
              // Client-side password match validation for the new password form
              (function(){
                const form = document.getElementById('newPasswordForm');
                if (!form) return;
                const pwd1 = document.getElementById('id_new_password1');
                const pwd2 = document.getElementById('id_new_password2');
                const submitBtn = form.querySelector('.btn-set-password');

                // create accessible feedback element under confirm field
                let feedback = document.getElementById('passwordMatchFeedback');
                if (!feedback) {
                  feedback = document.createElement('div');
                  feedback.id = 'passwordMatchFeedback';
                  feedback.className = 'invalid-feedback d-block';
                  feedback.style.display = 'none';
                  feedback.setAttribute('aria-live', 'polite');
                  if (pwd2 && pwd2.parentElement) pwd2.parentElement.insertAdjacentElement('afterend', feedback);
                }

                function updateState() {
                  const v1 = pwd1 ? pwd1.value : '';
                  const v2 = pwd2 ? pwd2.value : '';
                  if (!pwd1 || !pwd2 || !submitBtn) return;
                  if (v2.length === 0) {
                    // neutral
                    pwd2.classList.remove('is-invalid');
                    pwd2.classList.remove('is-valid');
                    feedback.style.display = 'none';
                    submitBtn.disabled = false;
                    return;
                  }
                  if (v1 === v2) {
                    pwd2.classList.remove('is-invalid');
                    pwd2.classList.add('is-valid');
                    feedback.style.display = 'none';
                    submitBtn.disabled = false;
                  } else {
                    pwd2.classList.remove('is-valid');
                    pwd2.classList.add('is-invalid');
                    feedback.textContent = '{% trans "Passwords do not match. Please re-enter your new password." %}';
                    feedback.style.display = 'block';
                    submitBtn.disabled = true;
                  }
                }

                pwd1 && pwd1.addEventListener('input', updateState);
                pwd2 && pwd2.addEventListener('input', updateState);

                form.addEventListener('submit', function(e){
                  if (!pwd1 || !pwd2) return;
                  if (pwd1.value !== pwd2.value) {
                    e.preventDefault();
                    updateState();
                    pwd2.focus();
                  }
                });
              })();
            </script>

            <div class="d-flex justify-content-between align-items-center mt-2">
              <div class="small text-muted">{% trans "Didn't receive the code?" %}</div>
              <form method="post" action="{% url 'resend_password_reset_otp' %}" class="m-0 p-0 d-inline">{% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-light resend-btn"><i class="bi bi-arrow-repeat me-1"></i> {% trans "Send new OTP" %}</button>
              </form>
            </div>

            <div class="text-center mt-4">
              <a href="{% url 'account_login' %}" class="btn btn-sm btn-primary btn-back-login me-2" role="button" aria-label="{% trans 'Back to login page' %}" title="{% trans 'Return to the sign in page' %}" data-bs-toggle="tooltip" data-bs-placement="top"><i class="bi bi-box-arrow-in-right me-1" aria-hidden="true"></i><span class="d-none d-sm-inline">{% trans "Back to Login" %}</span></a>
              <span class="small text-muted">{% trans "Don't have an account?" %}</span>
              <a href="{% url 'account_signup' %}" class="ms-1 btn btn-sm btn-primary signup-link px-3">{% trans "Sign up here" %}</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Reuse login background / styles for a consistent OTP page look. */
:root {
  --primary-color: #00d4ff;
  --secondary-color: #7b2cbf;
  --accent-color: #ff006e;
  --dark-bg: #0a0e27;
  --darker-bg: #050816;
  --text-light: #e2e8f0;
  --text-muted: #ffffff;
}
#particles-canvas-login { position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; background: linear-gradient(135deg, #050816 0%, #0a0e27 12%, #032b6b 30%, #064ea8 48%, #0652ff 66%, #00d4ff 82%, #0b3d91 100%); }
#three-container{ position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; }
#floating-elements{ position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none; overflow:visible; }
.float-elem{ position: absolute; border-radius: 50%; filter: blur(14px); opacity: 0.86; transform: translate3d(0,0,0); will-change: transform, opacity; }
.float-elem.e1{ width: 240px; height: 240px; left: 8%; top: 10%; background: radial-gradient(circle at 30% 30%, rgba(102,126,234,0.9), rgba(118,75,162,0.5)); animation: float1 12s ease-in-out infinite; }
.float-elem.e2{ width: 160px; height: 160px; right: 10%; top: 18%; background: radial-gradient(circle at 70% 30%, rgba(0,212,255,0.85), rgba(102,126,234,0.35)); animation: float2 10s ease-in-out infinite; }
.float-elem.e3{ width: 200px; height: 200px; left: 18%; bottom: 12%; background: radial-gradient(circle at 20% 80%, rgba(255,0,146,0.85), rgba(123,44,191,0.28)); animation: float3 14s ease-in-out infinite; }
.float-elem.e4{ width: 120px; height: 120px; right: 22%; bottom: 20%; background: radial-gradient(circle at 60% 60%, rgba(0,212,255,0.6), rgba(102,126,234,0.22)); animation: float4 9s ease-in-out infinite; }
@keyframes float1{ 0%{ transform: translateY(0) translateX(0) scale(1); opacity:0.78 } 50%{ transform: translateY(-30px) translateX(12px) scale(1.03); opacity:0.95 } 100%{ transform: translateY(0) translateX(0) scale(1); opacity:0.78 } }
@keyframes float2{ 0%{ transform: translateY(0) translateX(0) scale(1); opacity:0.6 } 50%{ transform: translateY(-22px) translateX(-8px) scale(1.04); opacity:0.85 } 100%{ transform: translateY(0) translateX(0) scale(1); opacity:0.6 } }
@keyframes float3{ 0%{ transform: translateY(0) translateX(0) scale(1); opacity:0.72 } 50%{ transform: translateY(-40px) translateX(18px) scale(1.02); opacity:0.9 } 100%{ transform: translateY(0) translateX(0) scale(1); opacity:0.72 } }
@keyframes float4{ 0%{ transform: translateY(0) translateX(0) scale(1); opacity:0.65 } 50%{ transform: translateY(-18px) translateX(6px) scale(1.06); opacity:0.9 } 100%{ transform: translateY(0) translateX(0) scale(1); opacity:0.65 } }
.futuristic-otp-container { position: relative; z-index: 1; }
.glass-card-otp { background: rgba(8,12,24,0.36); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px); border: 1px solid rgba(0, 212, 255, 0.08); border-radius: 20px; box-shadow: 0 12px 30px rgba(2,6,23,0.45); overflow: hidden; }
.card-header-otp { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); border:none; }
.card-body-otp { background: rgba(8,12,24,0.28); }

/* New-password card: center and style for clarity */
.new-password-card {
  max-width: 640px;
  margin: 1.25rem auto;
  padding: 1rem 1.25rem;
  border-radius: 14px;
  background: rgba(10,14,28,0.48);
  box-shadow: 0 12px 30px rgba(2,6,23,0.5);
  border: 1px solid rgba(255,255,255,0.04);
}

/* Password input helpers */
.password-wrapper { margin-bottom: 1rem; }
.input-group .password-input { border-right: 0; }
.password-toggle-btn {
  border-left: 0;
  background: transparent;
  color: #e6f7ff;
  border-radius: 0 8px 8px 0;
  min-width: 48px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: background .15s ease, color .15s ease, transform .08s ease;
}
.password-toggle-btn:hover { background: rgba(255,255,255,0.03); color: #ffffff; transform: translateY(-1px); }
.password-toggle-btn:active { transform: translateY(0); }
.password-toggle-btn i { font-size: 1.05rem; }

/* Ensure inputs have high contrast in dark and light modes */
.futuristic-otp-container .form-control.password-input,
.futuristic-otp-container .form-control {
  color: #ffffff !important;
  background: rgba(255,255,255,0.03) !important;
  border: 1px solid rgba(255,255,255,0.06) !important;
}
@media (prefers-color-scheme: light) {
  .futuristic-otp-container .form-control.password-input,
  .futuristic-otp-container .form-control {
    color: #111827 !important;
    background: #ffffff !important;
    border: 1px solid rgba(0,0,0,0.08) !important;
  }
  .password-toggle-btn { color: #1f2937; }
  .new-password-card { background: #ffffff !important; border: 1px solid rgba(0,0,0,0.06) !important; box-shadow: 0 6px 18px rgba(9,30,66,0.08); }
}

/* Small screens: make the inputs full width and buttons touch friendly */
@media (max-width: 576px) {
  .password-toggle-btn { min-width: 44px; }
  .new-password-card { padding: 0.9rem; margin: 0.75rem auto; }
}

/* Ensure page-level backgrounds don't show white under the canvas - prefer the login canvas/bg */
html, body {
  background: transparent !important;
}

/* Make any container/row/col inside the OTP area transparent to avoid white panels from utility classes */
.futuristic-otp-container,
.futuristic-otp-container .container,
.futuristic-otp-container .row,
.futuristic-otp-container .col,
.futuristic-otp-container .col-lg-6 {
  background: transparent !important;
}
.form-control-otp { letter-spacing: 0.4em; font-size: 1.5rem; font-weight:700; max-width:300px; margin:0 auto; }
.otp-sent-banner { background: linear-gradient(90deg,#109e75,#0ea46b); color:#fff; }
@media (max-width: 768px){ .float-elem.e1{ width: 140px; height: 140px; left: 4%; top: 6%; } .float-elem.e2{ width: 100px; height: 100px; right: 6%; top: 12%; } .float-elem.e3{ width: 120px; height: 120px; left: 10%; bottom: 8%; } .float-elem.e4{ width: 80px; height: 80px; right: 10%; bottom: 14%; } }

/* Force white text and dark-friendly inputs within OTP container */
.futuristic-otp-container,
.futuristic-otp-container h1,
.futuristic-otp-container h2,
.futuristic-otp-container h3,
.futuristic-otp-container h4,
.futuristic-otp-container p,
.futuristic-otp-container label,
.futuristic-otp-container a,
.futuristic-otp-container small,
.futuristic-otp-container .form-label,
.futuristic-otp-container .form-text,
.futuristic-otp-container .text-muted {
  color: #ffffff !important;
}

.futuristic-otp-container .form-control,
.futuristic-otp-container .form-select,
.futuristic-otp-container ::placeholder {
  color: #ffffff !important;
}

.futuristic-otp-container .bg-transparent { background: rgba(255,255,255,0.02) !important; }
{# Background and animations are now included from includes/_auth_background.html #}

/* Additional overrides to remove remaining white panels and make
   all auth cards/controls match the login-style dark glass look. */
.futuristic-otp-container .card,
.futuristic-otp-container .card-body,
.futuristic-otp-container .card-header,
.futuristic-otp-container .help-card,
.futuristic-otp-container .howitworks,
.futuristic-otp-container .new-password-card {
  background: rgba(15,23,42,0.7) !important; /* dark glass */
  color: #ffffff !important;
  border: 0 !important;
  box-shadow: 0 20px 40px rgba(2,6,23,0.6) !important;
}

/* Neutralize utility classes inside the OTP area that were adding white */
.futuristic-otp-container .bg-light,
.futuristic-otp-container .bg-white {
  background: rgba(255,255,255,0.02) !important;
  color: #ffffff !important;
}

/* Form inputs — dark transparent with white text and subtle borders */
.futuristic-otp-container .form-control,
.futuristic-otp-container input.form-control,
.futuristic-otp-container .form-select {
  background: rgba(255,255,255,0.02) !important;
  color: #ffffff !important;
  border: 1px solid rgba(255,255,255,0.06) !important;
}
.futuristic-otp-container .form-control::placeholder { color: rgba(255,255,255,0.6) !important; }

/* Buttons: prefer primary blue, but small outline buttons can be light-on-dark */
.futuristic-otp-container .btn-link,
.futuristic-otp-container .btn-outline-light {
  color: #00d4ff !important;
}

/* Make small muted text readable */
.futuristic-otp-container .text-muted,
.futuristic-otp-container small.text-muted {
  color: rgba(255,255,255,0.8) !important;
}

/* OTP-specific error styling: make verification errors clearly red and high-contrast */
.futuristic-otp-container .alert-danger {
  background: linear-gradient(90deg, rgba(255,230,230,0.04), rgba(255,20,20,0.02));
  border: 1px solid rgba(255,60,60,0.16) !important;
  color: #fff0f0 !important; /* general text: very light for readability on dark glass */
}
.futuristic-otp-container .alert-danger .bi {
  color: #ff3b3b !important; /* icon: vivid red */
}
.futuristic-otp-container .alert-danger strong,
.futuristic-otp-container .alert-danger h4 {
  color: #ff2b2b !important; /* heading/strong: clear red */
}
.futuristic-otp-container .alert-danger p,
.futuristic-otp-container .alert-danger span,
.futuristic-otp-container .alert-danger ul li {
  color: #ff4d4d !important; /* message lines: red */
  font-weight: 700;
}
.futuristic-otp-container .alert-danger .btn-close {
  filter: none; /* leave close button visible */
  opacity: 0.95;
}

/* Also style messages that render as `alert-error` (message.tag == 'error') */
.futuristic-otp-container .alert-error {
  background: linear-gradient(90deg, rgba(255,230,230,0.04), rgba(255,20,20,0.02));
  border: 1px solid rgba(255,60,60,0.16) !important;
  color: #fff0f0 !important;
}
.futuristic-otp-container .alert-error .bi {
  color: #ff3b3b !important;
}
.futuristic-otp-container .alert-error strong,
.futuristic-otp-container .alert-error h4 {
  color: #ff2b2b !important;
}
.futuristic-otp-container .alert-error p,
.futuristic-otp-container .alert-error span,
.futuristic-otp-container .alert-error ul li {
  color: #ff4d4d !important;
  font-weight: 700;
}
.futuristic-otp-container .alert-error .btn-close {
  filter: none; /* leave close button visible */
  opacity: 0.95;
}

/* Match login page header and button colors (blue gradient) */
.card-header-otp { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); border: none; }
.btn-verify { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); border: 0; }
.btn-verify:hover { filter: brightness(1.05); transform: translateY(-2px); }
.otp-sent-banner { background: linear-gradient(90deg, rgba(0,212,255,0.06), rgba(123,44,191,0.04)); border: 1px solid rgba(0,212,255,0.06); color: #eaf6ff; }
.otp-info-section .display-5 { color: #ffffff !important; text-shadow: 0 6px 20px rgba(0,0,0,0.6); }
.futuristic-otp-container .btn-link, .futuristic-otp-container .btn-outline-light { color: var(--primary-color) !important; }

/* -----------------------------
   GLOBAL VISUAL ENHANCEMENTS
   Improve typography, spacing, inputs, buttons and responsive rules
   ----------------------------- */
.futuristic-otp-container {
  background: transparent !important;
  font-family: 'Inter', 'Poppins', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  line-height: 1.45;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  padding: 2.5rem 0;
}

.glass-card-otp {
  border-radius: 20px;
  overflow: hidden;
}

.card-header-otp {
  padding: 1.4rem 1rem;
  font-size: 1.15rem;
  letter-spacing: 0.3px;
}

.card-body-otp {
  padding: 2rem;
}

/* Buttons */
.btn-verify,
.btn-send-otp,
.btn-primary,
.btn-send-otp.btn-primary {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
  border: 0 !important;
  box-shadow: 0 10px 30px rgba(2,6,23,0.45);
  padding: 12px 18px;
  border-radius: 12px;
  font-weight: 700;
  transition: transform 180ms ease, box-shadow 180ms ease;
}
.btn-verify:hover,
.btn-send-otp:hover { transform: translateY(-3px); }
.btn-verify:focus, .btn-send-otp:focus { outline: none; box-shadow: 0 0 0 6px rgba(0,212,255,0.08); }

/* Inputs */
.futuristic-otp-container .form-control,
.futuristic-otp-container .form-control-lg {
  padding: 12px 14px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.06) !important;
}
.futuristic-otp-container .form-control:focus {
  box-shadow: 0 0 0 6px rgba(0,212,255,0.06);
  border-color: var(--primary-color) !important;
}

/* OTP input styling */
.form-control-otp {
  letter-spacing: 0.6em;
  font-size: 1.8rem;
  font-weight: 800;
  max-width: 320px;
  padding: 10px 14px;
  border-radius: 12px;
  margin: 0 auto;
  text-align: center;
}

/* Feature list & icons */
.feature-list .feature-item { gap: 14px; align-items: flex-start; }
.feature-icon { width: 46px; height: 46px; display: inline-flex; align-items:center; justify-content:center; border-radius:10px; }
.feature-icon i { font-size: 1.25rem; }

/* OTP banner */
.otp-sent-banner { display:flex; align-items:center; gap:14px; padding: 12px; border-radius:12px; }

/* Enhanced OTP banner logo */
.otp-sent-banner .otp-banner-logo { width:56px; height:56px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; overflow:hidden; flex: none; }
.otp-sent-banner .otp-logo { width:44px; height:44px; transition: transform .18s ease, filter .18s ease; display:block; }
.otp-sent-banner .otp-banner-logo:hover .otp-logo { transform: scale(1.06); filter: drop-shadow(0 8px 18px rgba(124,58,237,0.18)); }
.otp-sent-banner .otp-banner-logo svg { display:block; }

/* Muted text adjustments */
.futuristic-otp-container .text-muted { color: rgba(255,255,255,0.82) !important; }

/* Responsive tweaks */
@media (max-width: 992px) {
  .card-body-otp { padding: 1.25rem; }
  .futuristic-otp-container { padding: 1.25rem 0; }
  .form-control-otp { font-size: 1.4rem; letter-spacing: 0.5em; }
}

/* Ensure the page background is blue (not white) and shows behind the canvas
   and glass cards. Use the same blended A..E gradient used for the particle
   canvas as a fallback for environments where the canvas might not cover. */
/* Use the login page background (canvas + three.js) as the primary background.
   Removed html/body forced gradient so the canvas background from
   #particles-canvas-login (copied from login.html) will show through. */
/* Ensure the OTP banner and the displayed email are always visible
   and high-contrast regardless of utility classes or theme overrides. */
.futuristic-otp-container .hidden-until-focus {
  display: flex !important;
  opacity: 1 !important;
  pointer-events: auto !important;
}

.otp-sent-banner .sent-email {
  /* Make the sent email clearly visible in red (overrides earlier dark/black renderings) */
  color: #ff4d4f !important; /* accessible red */
  font-weight: 700 !important;
  display: inline-block !important;
  max-width: 320px; /* avoid overflow */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  vertical-align: middle;
}

.otp-sent-banner .text-muted {
  color: rgba(234,246,255,0.95) !important;
}
/* Password strength & form UX styles */
.new-password-card { transition: transform .18s ease, opacity .18s ease; }
.password-toggle-btn { transition: transform .12s ease, color .12s ease; border: none; background: transparent; padding: 0.45rem; }
.password-toggle-btn:active { transform: scale(.98); }
.password-toggle-btn i { transition: transform .18s ease; }

#passwordRules { column-gap: 12px; }
#passwordRules .rule { color: #ff6b6b; transition: color .12s ease, transform .12s ease; }
#passwordRules .rule.satisfied { color: #7CFC00; transform: translateX(0); }
#passwordStrengthLabel.weak { color: #ff6b6b; }
#passwordStrengthLabel.good { color: #ffd43b; }
#passwordStrengthLabel.strong { color: #7CFC00; }

#passwordMatch { transition: opacity .22s ease, max-height .22s ease; }
.invalid-feedback[style] { transition: opacity .22s ease; }

/* Button enabled state */
.btn-set-password[disabled] { opacity: 0.55; transform: none; cursor: not-allowed; }
.btn-set-password:not([disabled]) { box-shadow: 0 8px 22px rgba(0,212,255,0.12); transform: translateY(-2px); }
{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Particle animation + small page scripts copied from login.html
  const canvas = document.getElementById('particles-canvas-login');
  if (canvas) {
  // Make canvas non-interactive and bring it forward so the animation is visually primary
  canvas.style.pointerEvents = 'none';
  canvas.style.zIndex = '0';

    const ctx = canvas.getContext('2d');

    // HiDPI support
    function resizeCanvas() {
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      canvas.width = Math.round(window.innerWidth * dpr);
      canvas.height = Math.round(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    resizeCanvas();

    const particles = [];
    // Increase count/visibility so the particle field is the primary visual
    const particleCount = Math.max(60, Math.floor((window.innerWidth / 12)) );

    class Particle {
      constructor() {
        this.x = Math.random() * window.innerWidth;
        this.y = Math.random() * window.innerHeight;
        this.size = Math.random() * 3.5 + 1.5; // slightly larger
        this.speedX = (Math.random() * 1.2 - 0.6) * 0.6;
        this.speedY = (Math.random() * 1.2 - 0.6) * 0.6;
        this.opacity = Math.random() * 0.6 + 0.35; // brighter
      }
      update() {
        this.x += this.speedX;
        this.y += this.speedY;
        if (this.x > window.innerWidth) this.x = 0;
        if (this.x < 0) this.x = window.innerWidth;
        if (this.y > window.innerHeight) this.y = 0;
        if (this.y < 0) this.y = window.innerHeight;
      }
      draw() {
        ctx.fillStyle = `rgba(0, 212, 255, ${this.opacity})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
      }
    }

    function initParticles() {
      particles.length = 0;
      for (let i = 0; i < particleCount; i++) particles.push(new Particle());
    }

    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < particles.length; i++) {
        particles[i].update();
        particles[i].draw();
        for (let j = i + 1; j < particles.length; j++) {
          const dx = particles[i].x - particles[j].x;
          const dy = particles[i].y - particles[j].y;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const maxDist = 160; // longer connecting lines
          if (distance < maxDist) {
            const alpha = 0.22 * (1 - distance / maxDist);
            ctx.strokeStyle = `rgba(0, 212, 255, ${alpha})`;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(particles[i].x, particles[i].y);
            ctx.lineTo(particles[j].x, particles[j].y);
            ctx.stroke();
          }
        }
      }
      requestAnimationFrame(animateParticles);
    }

    initParticles();
    animateParticles();

    window.addEventListener('resize', function() {
      resizeCanvas();
      initParticles();
    });
  }

  // Password toggle handlers (delegated): works even if elements are added dynamically
  (function() {
    function findAssociatedInput(btn) {
      const wrapper = btn.closest('.password-wrapper');
      let input = null;
      if (wrapper) input = wrapper.querySelector('input[type="password"], input[type="text"], input');
      if (!input) {
        const target = btn.getAttribute('data-target') || btn.dataset.target;
        if (target) input = document.querySelector(target);
      }
      if (!input) {
        const prev = btn.previousElementSibling;
        if (prev && prev.tagName) input = prev.querySelector('input') || (prev.tagName.toLowerCase() === 'input' ? prev : null);
      }
      return input;
    }

    function toggleForButton(btn) {
      try {
        const input = findAssociatedInput(btn);
        if (!input) return;
        const wasHidden = input.type === 'password';
        input.type = wasHidden ? 'text' : 'password';

        const icon = btn.querySelector('i, svg');
        const newState = wasHidden ? 'visible' : 'hidden';

        // If icon is an <i> (font icon), toggle classes
        if (icon && icon.tagName && icon.tagName.toLowerCase() === 'i') {
          try {
            icon.classList.remove('bi-eye', 'bi-eye-slash');
            icon.classList.add(wasHidden ? 'bi-eye-slash' : 'bi-eye');
          } catch (e) { /* ignore */ }
        }

        // If icon is an inline SVG, update its paths to reflect visible/hidden
        if (icon && icon.tagName && icon.tagName.toLowerCase() === 'svg') {
          try {
            if (newState === 'visible') {
              icon.innerHTML = '<path fill="none" stroke="currentColor" stroke-width="1.5" d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z"/><circle cx="12" cy="12" r="3" fill="currentColor"/>';
            } else {
              icon.innerHTML = '<path fill="none" stroke="currentColor" stroke-width="1.5" d="M17.94 17.94A9.96 9.96 0 0 1 12 19c-6 0-10-7-10-7 .93-1.63 2.22-3.16 3.74-4.45M1 1l22 22"/><path d="M9.53 9.53A3 3 0 0 0 12 15a3 3 0 0 0 2.47-1.47" stroke="currentColor" stroke-width="1.5" fill="none"/>';
            }
          } catch (e) { /* ignore */ }
        }

        // If no icon present, insert a font-icon <i>
        if (!icon) {
          try {
            const i = document.createElement('i');
            i.className = wasHidden ? 'bi bi-eye-slash' : 'bi bi-eye';
            i.setAttribute('aria-hidden', 'true');
            btn.appendChild(i);
          } catch (e) { /* ignore */ }
        }

        btn.setAttribute('aria-pressed', wasHidden ? 'true' : 'false');
        btn.setAttribute('aria-label', wasHidden ? 'Hide password' : 'Show password');
        try { btn.focus(); } catch (e) { /* ignore */ }
      } catch (err) { console.warn('Password toggle failed', err); }
    }

    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.password-toggle-btn');
      if (!btn) return;
      e.preventDefault();
      toggleForButton(btn);
    }, true);

    // keyboard support when focus is on the button
    document.addEventListener('keydown', function(e) {
      const active = document.activeElement;
      if (!active || !active.classList) return;
      if (!active.classList.contains('password-toggle-btn')) return;
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        toggleForButton(active);
      }
    }, true);
  })();

  // Toast init
  (function() {
    try {
      const successAlert = document.querySelector('.alert-success');
      if (successAlert) {
        const toastEl = document.getElementById('globalToast');
        const toastBody = document.getElementById('globalToastBody');
        if (toastEl && toastBody) {
          toastBody.innerHTML = successAlert.innerHTML;
          successAlert.remove();
          const bsToast = new bootstrap.Toast(toastEl, { delay: 5000 });
          bsToast.show();
        }
      }
    } catch (e) { console.warn('Toast init failed', e); }
  })();

    // Open-mail button: determine webmail URL from the sent email and wire the button.
    (function() {
      try {
        const openBtn = document.getElementById('openMailBtn');
        if (!openBtn) return;

        // Prefer data-email on the banner, then .sent-email text, then input field value
        const banner = document.querySelector('.otp-sent-banner');
        let email = banner ? banner.dataset.email || '' : '';
        if (!email) {
          const sentEl = document.querySelector('.sent-email');
          email = sentEl ? sentEl.textContent.trim() : '';
        }
        if (!email) {
          const hiddenInput = document.getElementById('id_email');
          email = hiddenInput ? hiddenInput.value.trim() : '';
        }

        function buildWebmailUrl(address) {
          if (!address) return null;
          const domain = address.split('@').pop().toLowerCase();
          if (/^(gmail|googlemail)\./i.test(domain) || domain === 'gmail.com' || domain === 'googlemail.com') return 'https://mail.google.com/';
          if (/^(hotmail|outlook|live)\./i.test(domain) || ['outlook.com','hotmail.com','live.com','msn.com'].includes(domain)) return 'https://outlook.live.com/mail/0/';
          if (domain.endsWith('yahoo.com') || domain.endsWith('yahoo.co')) return 'https://mail.yahoo.com/';
          if (domain.endsWith('icloud.com') || domain.endsWith('me.com')) return 'https://www.icloud.com/mail';
          if (domain.endsWith('protonmail.com')) return 'https://mail.proton.me/';
          if (domain.endsWith('zoho.com')) return 'https://mail.zoho.com/';
          if (domain.endsWith('qq.com')) return 'https://mail.qq.com/';
          // generic webmail fallback — open mailto: link when unknown
          return null;
        }

        const providerUrl = buildWebmailUrl(email);
        if (providerUrl) {
          openBtn.setAttribute('href', providerUrl);
          openBtn.setAttribute('target', '_blank');
          openBtn.addEventListener('click', function(e) {
            // open in new tab/window
            e.preventDefault();
            try { window.open(providerUrl, '_blank', 'noopener'); } catch (err) { window.location.href = providerUrl; }
          });
        } else if (email) {
          // fallback to mailto with recipient set
          const mailto = 'mailto:' + encodeURIComponent(email);
          openBtn.setAttribute('href', mailto);
          openBtn.addEventListener('click', function(e) {
            // allow default mailto behavior but also attempt to open
            try { window.location.href = mailto; } catch (err) { /* noop */ }
          });
        } else {
          // no email available — disable the button
          openBtn.classList.add('disabled');
          openBtn.setAttribute('aria-disabled', 'true');
          openBtn.removeAttribute('href');
        }
      } catch (err) { console.warn('Open-mail init failed', err); }
    })();

  // OTP banner close behavior: hide the banner and persist the close in sessionStorage
  (function(){
    document.addEventListener('click', function(e){
      const btn = e.target.closest('#otpBannerClose');
      if (!btn) return;
      const banner = btn.closest('.otp-sent-banner');
      if (!banner) return;
      // smooth fade then hide
      banner.style.transition = 'opacity .28s ease';
      banner.style.opacity = '0';
      setTimeout(function(){
        try { banner.style.display = 'none'; banner.setAttribute('aria-hidden','true'); } catch(e){}
      }, 300);
      // remember for this session for the specific email
      const email = banner.dataset.email || (banner.querySelector('.sent-email') ? banner.querySelector('.sent-email').textContent.trim() : '');
      if (email) {
        try { sessionStorage.setItem('otpBannerClosed_' + email, '1'); } catch(e){/* ignore */}
      }
    }, true);

    // On load hide any banners user previously closed this session
    try {
      document.querySelectorAll('.otp-sent-banner').forEach(function(banner){
        const email = banner.dataset.email || (banner.querySelector('.sent-email') ? banner.querySelector('.sent-email').textContent.trim() : '');
        if (email && sessionStorage.getItem('otpBannerClosed_' + email)) {
          banner.style.display = 'none';
          banner.setAttribute('aria-hidden','true');
        }
      });
    } catch(e){}
  })();
});
</script>
<!-- Three.js and GSAP for home-like background animation (same includes as login) -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11000;">
  <div id="globalToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="globalToastBody"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
<script src="{% static 'js/home-animations.js' %}"></script>

<script>
// Advanced password UX: mirror signup page behavior for strength, checklist, match and gating
document.addEventListener('DOMContentLoaded', function(){
  const pwd1 = document.getElementById('id_new_password1');
  const pwd2 = document.getElementById('id_new_password2');
  const submitBtn = document.querySelector('.btn-set-password');
  const strengthLabel = document.getElementById('passwordStrengthLabel');
  const progressBar = document.getElementById('passwordStrengthBar');
  const strengthRegion = document.getElementById('password-strength-region');
  const reqLength = document.getElementById('req-length');
  const reqUpper = document.getElementById('req-uppercase');
  const reqLower = document.getElementById('req-lowercase');
  const reqNumber = document.getElementById('req-number');
  const matchEl = document.getElementById('passwordMatch');

  if (!pwd1 || !pwd2) return;

  function updateRequirement(el, met) {
    if (!el) return;
    const icon = el.querySelector('i');
    if (met) {
      if (icon) icon.className = 'bi bi-check-circle-fill text-success';
      el.style.color = '#28a745';
      el.classList.add('met');
    } else {
      if (icon) icon.className = 'bi bi-x-circle text-danger';
      el.style.color = '';
      el.classList.remove('met');
    }
  }

  function computeStrength(pw) {
    const reqs = {
      length: pw.length >= 8,
      uppercase: /[A-Z]/.test(pw),
      lowercase: /[a-z]/.test(pw),
      number: /[0-9]/.test(pw)
    };
    return reqs;
  }

  function updateUI() {
    const v1 = pwd1.value || '';
    const v2 = pwd2.value || '';
    const r = computeStrength(v1);
    // update requirement items
    updateRequirement(reqLength, r.length);
    updateRequirement(reqUpper, r.uppercase);
    updateRequirement(reqLower, r.lowercase);
    updateRequirement(reqNumber, r.number);

    // compute score
    const passed = [r.length, r.uppercase, r.lowercase, r.number].filter(Boolean).length;
    let color = '#dc3545', text = 'Very Weak', pct = 0;
    if (passed === 0) { color = '#dc3545'; text = 'Very Weak'; pct = 0; }
    else if (passed <= 1) { color = '#dc3545'; text = 'Weak'; pct = 25; }
    else if (passed === 2) { color = '#ffc107'; text = 'Fair'; pct = 50; }
    else if (passed === 3) { color = '#28a745'; text = 'Good'; pct = 75; }
    else { color = '#16a34a'; text = 'Strong'; pct = 100; }

    // update progress bar and label
    if (progressBar) {
      progressBar.style.width = pct + '%';
      progressBar.style.backgroundColor = color;
      if (pct === 100) progressBar.classList.add('progress-strong'); else progressBar.classList.remove('progress-strong');
    }
    if (strengthLabel) {
      strengthLabel.textContent = text;
      strengthLabel.className = '';
      // add semantic class
      if (text === 'Very Weak') strengthLabel.classList.add('very-weak');
      else if (text === 'Weak') strengthLabel.classList.add('weak');
      else if (text === 'Fair') strengthLabel.classList.add('fair');
      else if (text === 'Good') strengthLabel.classList.add('good');
      else strengthLabel.classList.add('strong');
      strengthLabel.setAttribute('aria-label', text + ' password strength');
    }

    // show/hide match message only when both non-empty
    if (v1.length > 0 && v2.length > 0 && v1 !== v2) {
      if (matchEl) { matchEl.style.display = 'block'; matchEl.style.opacity = '1'; }
    } else {
      if (matchEl) { matchEl.style.opacity = '0'; setTimeout(()=> matchEl.style.display = (v1.length>0 && v2.length>0 && v1!==v2) ? 'block' : 'none', 220); }
    }

    // enable submit only when all requirements met and passwords match
    const allOk = r.length && r.uppercase && r.lowercase && r.number && v1 === v2 && v1.length>0;
    if (submitBtn) {
      if (allOk) { submitBtn.removeAttribute('disabled'); submitBtn.removeAttribute('aria-disabled'); }
      else { submitBtn.setAttribute('disabled',''); submitBtn.setAttribute('aria-disabled','true'); }
    }
  }

  // wire events
  pwd1.addEventListener('input', function(){
    // show strength region when user starts typing
    if (strengthRegion) strengthRegion.style.display = 'block';
    updateUI();
  });
  pwd2.addEventListener('input', updateUI);

  // initial update (no match warning shown until user types)
  setTimeout(updateUI, 50);

  // small eye icon animation (keeps parity with signup)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.password-toggle-btn');
    if (!btn) return;
    const icon = btn.querySelector('i');
    if (!icon) return;
    icon.style.transform = 'rotateY(20deg)';
    setTimeout(()=> icon.style.transform = '', 220);
  }, true);

});
</script>
